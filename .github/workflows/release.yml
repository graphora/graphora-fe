name: Release

on:
  push:
    tags:
      - '20*-v*'  # Matches YYYY-MM-vX.Y.Z format
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version (e.g., 1.1.0) - will be prefixed with YYYY-MM-'
        required: true
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: false

permissions:
  contents: write

env:
  NEXT_TELEMETRY_DISABLED: '1'

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      BACKEND_API_URL: ${{ vars.BACKEND_API_URL != '' && vars.BACKEND_API_URL || 'http://localhost:8000' }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      CLERK_BACKEND_TOKEN_TEMPLATE: ${{ vars.CLERK_BACKEND_TOKEN_TEMPLATE != '' && vars.CLERK_BACKEND_TOKEN_TEMPLATE || 'session_token' }}
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            app/package-lock.json

      - name: Get version
        id: version
        run: |
          YEAR_MONTH=$(date +%Y-%m)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SEMVER="${{ github.event.inputs.version }}"
            # Add v prefix if not present
            if [[ ! "$SEMVER" =~ ^v ]]; then
              SEMVER="v${SEMVER}"
            fi
            VERSION="${YEAR_MONTH}-${SEMVER}"
          else
            # Extract from tag (already in YYYY-MM-vX.Y.Z format)
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          npm ci
          npm --prefix app ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Update VERSION file
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || true
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main --tags

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- (feat|add|new|Add|Implement)" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- (fix|bug|patch|Fix)" || true)
          DOCS=$(echo "$COMMITS" | grep -E "^- (doc|docs)" || true)
          CHORES=$(echo "$COMMITS" | grep -E "^- (chore|refactor|style|test|ci)" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^- (feat|add|new|Add|Implement|fix|bug|patch|Fix|doc|docs|chore|refactor|style|test|ci)" || true)

          # Build changelog
          CHANGELOG=""
          [ -n "$FEATURES" ] && CHANGELOG="${CHANGELOG}## Features\n${FEATURES}\n\n"
          [ -n "$FIXES" ] && CHANGELOG="${CHANGELOG}## Bug Fixes\n${FIXES}\n\n"
          [ -n "$DOCS" ] && CHANGELOG="${CHANGELOG}## Documentation\n${DOCS}\n\n"
          [ -n "$OTHER" ] && CHANGELOG="${CHANGELOG}## Other Changes\n${OTHER}\n\n"

          # Save to file for release
          echo -e "$CHANGELOG" > RELEASE_NOTES.md
          echo "Generated changelog for ${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest --force
